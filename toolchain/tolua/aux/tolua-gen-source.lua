local function gen_include(module, write)
    local INCLUDES = trimlastlf(module.INCLUDES)
    write(format_snippet([[
        //
        // generated by tolua
        //
        ${INCLUDES}
    ]]))
    write('')
end

local function gen_classes(module, write)
    for i, cls in ipairs(module.CLASSES) do
        gen_class(module, cls, write)
        write('')
    end
end

local function gen_luaopen(module, write)
    local MODULE_NAME = module.NAME
    local REQUIRES = {}

    for i, cls in ipairs(module.CLASSES) do
        local LUACLS = cls.LUACLS
        local CPPCLS_PATH = class_path(cls.CPPCLS)
        REQUIRES[i] = format_snippet([[
            xlua_require(L, "${LUACLS}", luaopen_${CPPCLS_PATH});
        ]])
    end

    REQUIRES = table.concat(REQUIRES, "\n")
    write(format_snippet([[
        int luaopen_${MODULE_NAME}(lua_State *L)
        {
            ${REQUIRES}
            return 0;
        }
    ]]))
    write('')
end

function gen_source(module)
    local arr = {}
    local function append(value)
        arr[#arr + 1] = value
    end

    gen_include(module, append)
    gen_classes(module, append)
    gen_luaopen(module, append)
    write(PROJECT_ROOT .. module.SOURCE_PATH, table.concat(arr, "\n"))
end